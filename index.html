<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Task Board — HTML ↔︎ GS</title>
  <style>
    :root{
      --left-width: 20%;
      --right-width: 80%;
      --gap: 12px;
      --card-radius: 10px;
      --cell-size: 120px;
      --font-sans: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      font-family:var(--font-sans);
      margin:16px;
      background:#fafafa;
      color:#1f2937;
    }
    .container{
      display:flex;
      gap:var(--gap);
      height:calc(100vh - 40px);
      align-items:flex-start;
    }
    .left{
      width:var(--left-width);
      min-width:220px;
      background:linear-gradient(180deg,#ffffff,#fbfbff);
      border-radius:12px;
      padding:12px;
      box-shadow:0 6px 18px rgba(11,21,50,0.06);
      overflow:auto;
    }
    .left h2{font-size:16px;margin:6px 0 12px}
    .task-list{display:flex;flex-direction:column;gap:8px}
    .task{
      padding:10px 12px;
      border-radius:10px;
      cursor:grab;
      user-select:none;
      box-shadow:0 2px 6px rgba(10,20,40,0.06);
      min-height:44px;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      color:#0b1220;
    }
    .task .meta{font-size:12px;opacity:0.85;font-weight:500}
    .task[data-draggable="false"]{opacity:0.5;cursor:not-allowed}
    .right{
      width:var(--right-width);
      flex:1;
      background:#fff;
      border-radius:12px;
      padding:14px;
      box-shadow:0 8px 22px rgba(8,18,40,0.06);
      overflow:auto;
    }
    .grid-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
    .grid{
      display:grid;
      grid-template-columns:150px repeat(3,1fr);
      gap:10px;
      align-items:center;
    }
    .grid .col-title{
      padding:8px 10px;font-weight:700;background:#f6f7fb;border-radius:8px;
      text-align:center;
    }
    .grid .row-title{
      padding:8px 10px;font-weight:700;background:#f6f7fb;border-radius:8px;
    }
    .cell{
      height:var(--cell-size);
      border-radius:8px;
      background:linear-gradient(180deg,#ffffff,#fcfdff);
      border:1px dashed rgba(30,40,80,0.06);
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      padding:8px;
      gap:8px;
      overflow:auto;
      flex-direction:column;
    }
    .cell.drop-target{background:#f8fff5;border:2px dashed rgba(30,160,80,0.25)}
    .cell .placed-task{
      padding:6px 8px;border-radius:8px;font-weight:700;cursor:grab;
      display:inline-block;
      margin-bottom:6px;
      box-shadow:0 2px 6px rgba(20,30,50,0.06);
    }
    .small{font-size:12px;color:#536179}
    .footer{
      margin-top:12px;font-size:13px;color:#6b7280;display:flex;justify-content:space-between;align-items:center;
    }
    .badge{padding:4px 8px;border-radius:999px;background:#eef2ff;font-weight:700;font-size:13px}
    .btn{
      display:inline-block;padding:8px 12px;border-radius:8px;background:#111827;color:white;font-weight:700;cursor:pointer;
      text-decoration:none;
    }
    @media (max-width:900px){
      :root{--left-width:30%}
      .grid{grid-template-columns:120px repeat(3,1fr)}
      .cell{height:100px}
    }
    @media (max-width:600px){
      .container{flex-direction:column}
      .left{width:100%}
      .right{width:100%}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left" id="left">
      <h2>Task Distribution</h2>
      <div class="small">拉取自 GS2（每次页面加载）</div>
      <div style="height:8px"></div>
      <div class="task-list" id="taskList"></div>
    </div>
    <div class="right">
      <div class="grid-header">
        <div style="flex:1">
          <h3 style="margin:0">Schedule — 3/11/2025</h3>
          <div class="small">拖拽左侧任务到右侧目标格子（代表某人某时间做此任务）</div>
        </div>
        <div>
          <span class="badge" id="lastSaved">未保存</span>
        </div>
      </div>
      <div class="grid" id="grid"></div>
      <div class="footer">
        <div>自动保存间隔：30 秒 · 状态：<span id="status">等待</span></div>
        <div>
          <a id="manualSave" class="btn">立即保存</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    const GET_TASKS_URL = "https://script.google.com/macros/s/AKfycbxBoIgtUh1UkDmyrCdLVK_L7su20WNLr0zFSC1ryKeddjEsl65GLFjeNl5hsM0tj0-nNg/exec";
    const SAVE_ASSIGNMENTS_URL = "https://script.google.com/macros/s/AKfycbwBzFhb475cBiNYw050o3C8g-LPnmC0XBshdId_deW_K6TC8KEjLz5zC4GSt-Duo5V7UA/exec";
    const GS1_SHEET_ID = "1ReQc_Ob9_tN-EPmQRTugujTGCrnNp5_sN4juZtqA9Mk";
    const GS1_TAB_NAME = "3/11/2025";
    const ROW_NAMES = ["Albert","Bunyau","Cyril"];
    const TIMES = ["9:00","10:00","11:00"];
    const PASTEL_COLORS = ["#FFDDE1","#FFE7C7","#FFF7C2","#DFF7D8","#DFF1FF","#EAD7FF","#FDEEF9","#E8F8FF","#FFF0E6","#E8FFE8"];
    let tasks = [];
    let assignments = {};

    function hashStringToIndex(s, mod){
      let h=0;
      for(let i=0;i<s.length;i++){ h=(h<<5)-h + s.charCodeAt(i); h |= 0; }
      return Math.abs(h) % mod;
    }

    function renderGrid(){
      const grid = document.getElementById("grid");
      grid.innerHTML = "";
      const corner = document.createElement("div"); corner.className="col-title"; corner.textContent=""; grid.appendChild(corner);
      for(const t of TIMES){ const th=document.createElement("div"); th.className="col-title"; th.textContent=t; grid.appendChild(th); }
      for(const r of ROW_NAMES){
        const rowTitle=document.createElement("div"); rowTitle.className="row-title"; rowTitle.textContent=r; grid.appendChild(rowTitle);
        for(const t of TIMES){
          const cell=document.createElement("div"); cell.className="cell"; cell.dataset.row=r; cell.dataset.time=t; cell.dataset.key=`${r}||${t}`;
          cell.addEventListener("dragover", ev=>{ev.preventDefault();cell.classList.add("drop-target");});
          cell.addEventListener("dragleave", ev=>{cell.classList.remove("drop-target");});
          cell.addEventListener("drop", ev=>{ev.preventDefault();cell.classList.remove("drop-target"); onDropTaskToCell(ev.dataTransfer.getData("text/plain"),cell);});
          grid.appendChild(cell);
        }
      }
    }

    function renderTasks(){
      const list=document.getElementById("taskList"); list.innerHTML="";
      tasks.forEach(t=>{
        const div=document.createElement("div"); div.className="task"; div.draggable=true;
        div.dataset.taskId=t.taskId; div.dataset.salesOrder=t.salesOrder||""; div.dataset.client=t.client||""; div.dataset.itemNo=t.itemNo||"";
        div.innerHTML=`<div style="flex:1">${t.label}</div><div class="meta">${t.client}</div>`;
        const idx=hashStringToIndex(t.salesOrder||t.taskId,PASTEL_COLORS.length);
        div.style.background=PASTEL_COLORS[idx]; div.style.border="1px solid rgba(0,0,0,0.04)";
        div.addEventListener("dragstart", ev=>{ev.dataTransfer.setData("text/plain",t.taskId);});
        list.appendChild(div);
      });
    }

    function renderAssignments(){
      document.querySelectorAll(".cell").forEach(c=>c.innerHTML="");
      for(const key in assignments){
        const entry=assignments[key]; if(!entry) continue;
        const [row,time]=key.split("||");
        const cell=document.querySelector(`.cell[data-row="${row}"][data-time="${time}"]`);
        if(!cell) continue;
        const el=document.createElement("div"); el.className="placed-task"; el.draggable=true; el.dataset.taskId=entry.taskId; el.textContent=entry.label;
        const idx=hashStringToIndex(entry.salesOrder||entry.taskId,PASTEL_COLORS.length); el.style.background=PASTEL_COLORS[idx];
        el.addEventListener("dragstart", ev=>{ ev.dataTransfer.setData("text/plain",entry.taskId); ev.dataTransfer.setData("fromCell",key); });
        el.addEventListener("dblclick", ()=>{ delete assignments[key]; renderAssignments(); markDirty(); });
        cell.appendChild(el);
      }
    }

    function onDropTaskToCell(taskId,cell){
      const row=cell.dataset.row; const time=cell.dataset.time; const key=`${row}||${time}`;
      let taskObj=tasks.find(x=>x.taskId===taskId);
      if(!taskObj){
        for(const k in assignments){ if(assignments[k] && assignments[k].taskId===taskId){ const moving=assignments[k]; delete assignments[k]; assignments[key]=moving; renderAssignments(); markDirty(); return; } }
        return;
      }
      assignments[key]={taskId:taskObj.taskId,client:taskObj.client,salesOrder:taskObj.salesOrder,itemNo:taskObj.itemNo,label:taskObj.label};
      renderAssignments(); markDirty();
    }

    function enableReturnToLeft(){
      const left=document.getElementById("left");
      left.addEventListener("dragover", ev=>ev.preventDefault());
      left.addEventListener("drop", ev=>{
        ev.preventDefault();
        const taskId=ev.dataTransfer.getData("text/plain");
        const fromKey=ev.dataTransfer.getData("fromCell");
        if(fromKey){ delete assignments[fromKey]; renderAssignments(); markDirty(); }
      });
    }

    let saveTimer=null; let dirty=false;
    function markDirty(){ dirty=true; document.getElementById("status").textContent="已修改（等待自动保存）"; }

    function saveAssignments(manual=false){
      const arr=[];
      for(const key in assignments){ const val=assignments[key]; if(!val) continue; const [row,time]=key.split("||"); arr.push({rowName:row,time:time,taskId:val.taskId,client:val.client,salesOrder:val.salesOrder,itemNo:val.itemNo}); }
      const payload={sheetId:GS1_SHEET_ID,tabName:GS1_TAB_NAME,assignments:arr};
      document.getElementById("status").textContent="保存中...";

      // iframe+form POST
      const iframe=document.createElement("iframe"); iframe.style.display="none"; iframe.name="hidden_iframe_"+Date.now(); document.body.appendChild(iframe);
      const form=document.createElement("form"); form.action=SAVE_ASSIGNMENTS_URL; form.method="POST"; form.target=iframe.name;
      const input=document.createElement("input"); input.type="hidden"; input.name="payload"; input.value=JSON.stringify(payload); form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
      setTimeout(()=>{
        document.body.removeChild(form); document.body.removeChild(iframe);
        document.getElementById("lastSaved").textContent="上次保存: "+new Date().toLocaleTimeString();
        document.getElementById("status").textContent="已保存"; dirty=false; if(manual) flashSaved();
      },500);
    }

    function flashSaved(){
      const el=document.getElementById("lastSaved"); el.style.transition="transform 150ms"; el.style.transform="scale(1.05)";
      setTimeout(()=>el.style.transform="",200);
    }

    function startAutoSave(){ if(saveTimer) clearInterval(saveTimer); saveTimer=setInterval(()=>{ if(dirty) saveAssignments(false); },30000); }

    document.getElementById("manualSave").addEventListener("click", ()=> saveAssignments(true));

    async function fetchTasks(){
      try{
        const url=new URL(GET_TASKS_URL);
        url.searchParams.set("sheetId","1qHXrnXiL29CuikWOjWtuEwjlPEEOW21TY7-27ToF8VU");
        url.searchParams.set("tab","Client Name-Sales Order-Item No.");
        const res=await fetch(url.toString(),{cache:"no-store"});
        const j=await res.json();
        tasks=Array.isArray(j.tasks)?j.tasks:(Array.isArray(j)?j:[]);
      }catch(err){ console.error("fetchTasks error",err); tasks=[]; }
      renderTasks();
    }

    (function init(){ renderGrid(); enableReturnToLeft(); fetchTasks(); renderAssignments(); startAutoSave(); setInterval(()=>{if(!dirty) saveAssignments(false);},5*60*1000); })();

    window.__TB={renderGrid,renderTasks,renderAssignments,fetchTasks,assignments};
  </script>
</body>
</html>
